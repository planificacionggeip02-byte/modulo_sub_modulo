<!-- ============================================================
üìÅ app.html
L√≥gica de interacci√≥n de la interfaz (cliente)
============================================================ -->

console.log("üü¢ app.html cargado correctamente");

/**
 * üîÑ Mostrar m√≥dulo (cambia pesta√±as)
 */
function mostrarModulo(modulo) {
  // Oculta todos los m√≥dulos
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

  // Limpia todos los estados activos del men√∫
  document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
  document.querySelectorAll('.sub-menu li').forEach(item => item.classList.remove('active'));

  // Muestra el m√≥dulo solicitado
  const tab = document.getElementById(modulo);
  if (tab) tab.classList.add('active');

  // üîÑ Reset consistente al cambiar de m√≥dulo
  resetPanelDerecho();

  // Detecta si el m√≥dulo tiene un padre
  const padre = moduloPadre[modulo] || modulo;
  const link = document.querySelector(`.nav-link[data-module="${padre}"]`);
}

/**
 * üì• Cargar m√≥dulo din√°micamente desde Apps Script
 */
async function cargarModulo(nombre) {
  mostrarModulo(nombre);
  resetPanelDerecho();
  console.log(`üß† [LOG] Intentando cargar m√≥dulo: ${nombre}`);

  const destinoId = nombre + 'Body';
  const destino = document.getElementById(destinoId);

  console.log("DestinoId calculado:", destinoId);
  console.log("Elemento encontrado:", destino);

  if (!destino) {
    console.error(`‚ùå [ERROR] No se encontr√≥ el contenedor destino: #${destinoId}`);
    return;
  }

  destino.innerHTML = '<div style="padding:12px;">Cargando m√≥dulo‚Ä¶</div>';

  google.script.run
    .withSuccessHandler(function (html) {
      console.log("‚úÖ [CLIENTE] HTML recibido, longitud:", html ? html.length : 0);
      destino.innerHTML = html;

      // Fuerza ejecuci√≥n de scripts del fragmento
      [...destino.querySelectorAll("script")].forEach(function (oldScript) {
        const newScript = document.createElement("script");
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });

      console.log("‚úÖ [CLIENTE] Inserci√≥n completada.");
    })
    .withFailureHandler(function (e) {
      console.error("‚ùå [CLIENTE] Error del servidor:", e && e.message ? e.message : e);
      destino.innerHTML = `<div style="color:#b00020;padding:12px;">Error: ${e.message}</div>`;
    })
    .getModuloHTML(nombre); // ‚Üê corregido: usa el nombre din√°mico
}

/**
 * üì• Cargar subm√≥dulo din√°micamente
 */
async function cargarSubmodulo(nombreTecnico, nombreVisible) {
  console.log(`üß† [LOG] Intentando cargar subm√≥dulo: ${nombreTecnico}`);

  // 1. Ocultar imagen de fondo
  const fondo = document.getElementById("imagenFondo");
  if (fondo) fondo.style.display = "none";

  // 2. Mostrar t√≠tulo del subm√≥dulo
  const titulo = document.getElementById("submoduloTitulo");
  if (titulo) {
    titulo.style.display = "block";
    titulo.textContent = nombreVisible;
  }

  // 3. Renderizar contenido en el panel derecho
  const destino = document.getElementById("submoduloBody");
  if (!destino) {
    console.error("‚ùå [ERROR] No se encontr√≥ el contenedor destino: #submoduloBody");
    return;
  }

  destino.innerHTML = '<div style="padding:12px;">Cargando subm√≥dulo‚Ä¶</div>';

  google.script.run
    .withSuccessHandler(function (html) {
      console.log("‚úÖ [CLIENTE] HTML recibido para subm√≥dulo:", nombreTecnico);
      destino.innerHTML = html;

      // Fuerza ejecuci√≥n de scripts del fragmento
      [...destino.querySelectorAll("script")].forEach(function (oldScript) {
        const newScript = document.createElement("script");
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });
    })
    .withFailureHandler(function (e) {
      console.error("‚ùå [CLIENTE] Error al cargar subm√≥dulo:", e && e.message ? e.message : e);
      destino.innerHTML = `<div style="color:#b00020;padding:12px;">Error: ${e.message}</div>`;
    })
    .getModuloHTML(nombreTecnico); // el servidor ya sabe buscar ui/<nombreTecnico>
}

/**
 * üìÇ Expandir o contraer m√≥dulo lateral con comportamiento acorde√≥n
 */
function toggleMenu(element) {
  const item = element.closest('.nav-item');
  if (!item) return;

  // üîí Cierra todos los dem√°s m√≥dulos abiertos
  document.querySelectorAll('.nav-item.open').forEach(openItem => {
    if (openItem !== item) {
      openItem.classList.remove('open');
    }
  });

  // üîì Alterna el m√≥dulo actual (abre/cierra)
  item.classList.toggle('open');
}

/**
 * üìÇ Relaci√≥n de subm√≥dulos con su m√≥dulo padre
 */
const moduloPadre = {
  cargar_demanda: "ventas",
  cargar_aceptacion: "ventas",
  editar_usuario: "ventas",
  avanzar_casos: "analisis_riesgo_mo",
  reporte_ar: "analisis_riesgo_mo",
  rebajar_equipo: "almacen",
  reporte_alma: "almacen",
  aprov_servicio: "aprovisionamiento",
  reporte_apro: "aprovisionamiento",
  cargar_retiro: "retiro",
  reporte_reti: "retiro",
  cambio_plan: "planes",
  reporte_plan: "planes"
};

// Actualiza la franja blanca fija con el nombre del m√≥dulo
function actualizarEncabezadoModulo(nombreModulo) {
  const header = document.getElementById("topHeaderTitle");
  if (header) {
    header.textContent = `M√≥dulo: ${nombreModulo}`;
  }
}

/**
 * üîÑ Restaurar panel derecho al cambiar de m√≥dulo
 */
function resetPanelDerecho() {
  const fondo = document.getElementById("imagenFondo");
  const titulo = document.getElementById("submoduloTitulo");
  const destinoSub = document.getElementById("submoduloBody");

  console.log("[RESET] Restaurando panel derecho...");

  if (fondo) {
    fondo.style.display = "block";
    console.log("[RESET] Imagen de fondo visible");
  } else {
    console.warn("[RESET] No se encontr√≥ #imagenFondo");
  }

  if (titulo) {
    titulo.style.display = "none";
    titulo.textContent = "";
  } else {
    console.warn("[RESET] No se encontr√≥ #submoduloTitulo");
  }

  if (destinoSub) {
    destinoSub.innerHTML = "";
  } else {
    console.warn("[RESET] No se encontr√≥ #submoduloBody");
  }
}

// Escucha clics en m√≥dulos padres para actualizar encabezado y resetear panel derecho
document.querySelectorAll('.nav-link[data-module]').forEach(item => {
  item.addEventListener('click', () => {
    const nombreTecnico = item.getAttribute('data-module');
    const nombreVisible = nombresVisibles[nombreTecnico] || nombreTecnico;
    actualizarEncabezadoModulo(nombreVisible);
    resetPanelDerecho();
    // Opcional: cargarModulo(nombreTecnico);
  });
});

// Diccionario de nombres visibles para la franja blanca
const nombresVisibles = {
  dashboard: "Dashboard",
  buscar: "Buscar",
  ventas: "Ventas",
  analisis_riesgo_mo: "An√°lisis de Riesgo",
  almacen: "Almac√©n",
  aprovisionamiento: "Aprovisionamiento",
  retiro: "Retiro",
  planes: "Planes",
  reportes: "Reportes",
  configuracion: "Configuraci√≥n"
};
