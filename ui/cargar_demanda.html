<!-- ============================
üßæ Subm√≥dulo: Cargar Demanda
============================= -->
<div id="contenedor-formulario"></div>

<script>
  console.log("üß™ Maqueta Cargar Demanda inicial cargada (versi√≥n parche)");

  // ============================
  // üîß UTILIDADES DE NORMALIZACI√ìN
  // ============================
  // Aqu√≠ puedes empezar a escribir tus funciones JS
  // Convierte texto a ‚ÄúNombre Propio‚Äù (cada palabra con inicial may√∫scula)
    function toNombrePropio(str) {
    if (!str) return "";
    return str
      .toLowerCase()
      .split(/\s+/)
      .map(w => w.charAt(0).toUpperCase() + w.slice(1))
      .join(" ");
  }

  // Normaliza: elimina acentos y espacios/guiones (para comparaciones internas si hiciera falta)
  function normalizeKey(str) {
    return (str || "")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-zA-Z0-9_]/g, "")
      .toLowerCase();
  }

  // Valida solo d√≠gitos con longitud exacta
  function soloDigitos(str, lenExacta) {
    const clean = (str || "").replace(/\D/g, "");
    return lenExacta ? (clean.length === lenExacta ? clean : null) : clean;
  }

  // Formatea monto a "1.234,56"; si vac√≠o ‚Üí "0,00"
  function formatearMonto(montoStr) {
    let s = (montoStr || "").trim();
    if (!s) return "0,00";

    // Aceptar tanto coma como punto de decimales; normalizar a n√∫mero
    // 1) Remover puntos de miles y espacios
    s = s.replace(/\./g, "").replace(/\s+/g, "");
    // 2) Cambiar coma por punto para parseo
    s = s.replace(/,/g, ".");
    const n = parseFloat(s);
    if (isNaN(n)) return "0,00";

    // 3) Volver a cadena con punto decimal, luego transformarlo a miles con coma decimal
    const fixed = n.toFixed(2); // "1234.56"
    const [enteros, decimales] = fixed.split(".");
    // Inserta separadores de miles con punto
    const enterosConMiles = enteros.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return `${enterosConMiles},${decimales}`;
  }

  // RIF: Letra J/V/E + hasta 9 d√≠gitos; completa con ceros a la derecha hasta 9; sin espacios/guiones
  function normalizarRIF(input) {
    const s = (input || "").trim().toUpperCase().replace(/[\s-]/g, "");
    if (!/^[JVE]/.test(s)) return null;
    const letra = s.charAt(0);
    const digitos = s.slice(1).replace(/\D/g, "");
    if (digitos.length === 0 || digitos.length > 9) return null;
    const padded = digitos.padEnd(9, "0");
    return `${letra}${padded}`;
  }

  // Central: "NNNN" o "NNNNL" (L may√∫scula)
  function validarCentral(input) {
    const s = (input || "").trim().toUpperCase();
    if (/^\d{4}$/.test(s)) return s;
    if (/^\d{4}[A-Z]$/.test(s)) return s;
    return null;
  }

  // Combina COD + tel√©fono (7 d√≠gitos). Sin espacios/guiones.
  function concatCodTelefono(cod, tel7) {
    const t = (tel7 || "").replace(/\D/g, "");
    if (!cod || t.length !== 7) return null;
    return `${cod}${t}`;
  }

  // Voz IP: COD (3 d√≠gitos) + tel√©fono (7 d√≠gitos).
  function concatCod3Tel7(cod3, tel7) {
    const c = (cod3 || "").replace(/\D/g, "");
    const t = (tel7 || "").replace(/\D/g, "");
    if (c.length !== 3 || t.length !== 7) return null;
    return `${c}${t}`;
  }

  // Email: no permitir dominio cantv
  function validarEmailNoCantv(email) {
    const e = (email || "").trim();
    if (!e) return null;
    const cantv = /@cantv(\.com)?\.ve$/i;
    if (cantv.test(e)) return null;
    // Validaci√≥n b√°sica de email
    const basic = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return basic.test(e) ? e : null;
  }

    // ============================
    // üî∑ Render Formulario
    // ============================

    function renderFormulario(listas = {}) {
    console.log("üöÄ Entrando a renderFormulario con listas:", listas); // eliminar luego esta linea
    const form = document.createElement("form");
    form.id = "formCargaDemanda";
    form.onsubmit = enviarCargaDemanda;


    // ============================
    // üî∑ BLOQUE: Informaci√≥n Personal
    // ============================
    console.log("üî∑ Renderizando bloque Informaci√≥n Personal");   // eliminar luego esta linea
    const personal = document.createElement("fieldset");
    personal.className = "bloque-personal";
    personal.innerHTML = `<legend>Informaci√≥n Personal</legend>`;
    form.appendChild(personal);

    personal.appendChild(crearCampoTexto("Nombre Contacto", "nombrecontacto", true));
    personal.appendChild(crearCampoNumero("C√©dula", "cedula", true, { minLen: 7, maxLen: 8 }));
    personal.appendChild(crearCampoEmail("Correo", "correo", true));

    personal.appendChild(crearCampoTelefono("Tel√©fono", "telefono", true, "cod"));
    personal.appendChild(crearCampoTelefono("Tel√©fono 2", "telefono2", false, "cod2"));
    personal.appendChild(crearCampoTelefono("Tel√©fono 3", "telefono3", false, "cod3"));
    console.log("‚úÖ Bloque Informaci√≥n Personal completado");   // eliminar luego esta linea


    // ============================
    // üî∑ BLOQUE: Informaci√≥n Cliente
    // ============================
    console.log("üî∑ Renderizando bloque Informaci√≥n Cliente");   // eliminar luego esta linea
    const cliente = document.createElement("fieldset");
    cliente.className = "bloque-cliente";
    cliente.innerHTML = `<legend>Informaci√≥n Cliente</legend>`;
    form.appendChild(cliente);

    cliente.appendChild(crearCampoTexto("Cliente", "cliente", true));
    cliente.appendChild(crearCampoTexto("Rif", "rif", true));
    cliente.appendChild(crearCampoTexto("Calle", "calle", false));
    cliente.appendChild(crearCampoTexto("Edificio", "edificio", false));
    cliente.appendChild(crearCampoTexto("Piso", "piso", false));
    cliente.appendChild(crearCampoTexto("Local", "local", false));
    cliente.appendChild(crearCampoSelect("Regi√≥n", "region", listas["Lista_Region"], true));
    cliente.appendChild(crearCampoSelect("Gerente Regi√≥n", "gerenteregion", listas["Lista_Gerente_Region"] || [], false));
    cliente.appendChild(crearCampoSelect("Estado", "estado", listas["Lista_Estado"] || [], false));
    cliente.appendChild(crearCampoSelect("Municipio", "municipio", listas["Lista_Municipio"] || [], false));
    cliente.appendChild(crearCampoTexto("Ciudad", "ciudad", false));
    cliente.appendChild(crearCampoSelect("Huella", "huella", listas["Lista_ODN"] || [], false));
    cliente.appendChild(crearCampoTexto("Sector", "sector", false));
    cliente.appendChild(crearCampoTexto("Cono O Modulo", "cono", false));
    console.log("‚úÖ Bloque Informaci√≥n Cliente completado");   // eliminar luego esta linea

    // ============================
    // üî∑ BLOQUE: Informaci√≥n Servicio
    // ============================
    console.log("üî∑ Renderizando bloque Informaci√≥n Servicio");   // eliminar luego esta linea
    const servicio = document.createElement("fieldset");
    servicio.className = "bloque-servicio";
    servicio.innerHTML = `<legend>Informaci√≥n Servicio</legend>`;
    form.appendChild(servicio);

    servicio.appendChild(crearCampoSelect("Medio Abordaje", "medioabordaje", listas["Lista_Medio_Abordaje"], true));
    servicio.appendChild(crearCampoSelect("Situaci√≥n Abordaje", "situacionabordaje", listas["Lista_Situacion"], true));
    servicio.appendChild(crearCampoDate("Fecha Abordaje", "fechaabordaje", true));
    servicio.appendChild(crearCampoSelect("Estatus Local", "estatuslocal", listas["Lista_Estatus"], true));
    servicio.appendChild(crearCampoRadioSiNo("Oferta Entregada", "ofertaentregada"));
    servicio.appendChild(crearCampoRadioSiNo("Oferta Aceptada", "ofertaaceptada"));
    servicio.appendChild(crearCampoSelect("Motivo No Aceptaci√≥n", "motivonoaceptacion", listas["Lista_No_Aceptacion"], false));
    servicio.appendChild(crearCampoDate("Fecha Aceptaci√≥n", "fechaaceptacion", false));
    servicio.appendChild(crearCampoSelect("Aceptaci√≥n Recibida Por", "aceptacionrecibidapor", listas["Lista_Aceptacion_por"], false));
    servicio.appendChild(crearCampoSelect("Abordado Por", "abordadopor", listas["Lista_Abordado_por"], false));
    console.log("‚úÖ Bloque Informaci√≥n Servicio completado");   // eliminar luego esta linea

    // ============================
    // üî∑ BOT√ìN DE ENV√çO
    // ============================
    const submitBtn = document.createElement("button");
    submitBtn.type = "submit";
    submitBtn.textContent = "Enviar Demanda";
    form.appendChild(submitBtn);

    // Insertar formulario en el contenedor principal
    const contenedor = document.getElementById("contenedor-formulario");
    contenedor.innerHTML = "";
    contenedor.appendChild(form);

    // Asociar env√≠o
    form.addEventListener("submit", enviarCargaDemanda);

    // üëá Aqu√≠ pegas el log
    console.log("‚úÖ Formulario renderizado y listener de env√≠o asociado");   // eliminar luego esta linea
  }

  // ============================
  // üß± CONSTRUCTORES DE CAMPOS (con comentarios gu√≠a)
  // ============================
  function crearCampoTexto(labelText, name, required) {
    const wrap = document.createElement("div");
    wrap.className = "campo texto";
    wrap.innerHTML = `
      <!-- üîπ Campo TEXTO: ${labelText} -->
      <label for="${name}">${labelText}</label>
      <input type="text" id="${name}" name="${name}" ${required ? "required" : ""} />
      <span class="estado"></span>
      <!-- üí¨ Validaci√≥n visual ‚úîÔ∏è/‚ùå integrada -->
    `;

    const input = wrap.querySelector(`#${name}`);
    const estado = wrap.querySelector(".estado");

    function validar() {
      const val = input.value.trim();
      if (val.length > 0) {
        // Capitalizaci√≥n autom√°tica
        input.value = toNombrePropio(val);
        input.classList.add("valido");
        input.classList.remove("invalido");
        estado.textContent = "‚úîÔ∏è";
        estado.className = "estado valido";
      } else {
        input.classList.add("invalido");
        input.classList.remove("valido");
        estado.textContent = "‚ùå";
        estado.className = "estado invalido";
      }
    }

    input.addEventListener("blur", validar);
    input.addEventListener("input", validar);

    return wrap;
  }

  function crearCampoNumero(labelText, name, required, opts = {}) {
  const wrap = document.createElement("div");
  wrap.className = "campo numero";
  wrap.innerHTML = `
    <!-- üîπ Campo N√öMERO: ${labelText} -->
    <label for="${name}">${labelText}</label>
    <input type="text" inputmode="numeric" id="${name}" name="${name}" 
           ${required ? "required" : ""} />
    <span class="estado"></span>
    <!-- üí¨ Validaci√≥n visual ‚úîÔ∏è/‚ùå integrada -->
  `;

  const input = wrap.querySelector(`#${name}`);
  const estado = wrap.querySelector(".estado");

  function validar() {
    const clean = (input.value || "").replace(/\D/g, "");
    const minLen = opts.minLen || 0;
    const maxLen = opts.maxLen || Infinity;

    if (clean.length >= minLen && clean.length <= maxLen && clean.length > 0) {
      input.classList.add("valido");
      input.classList.remove("invalido");
      estado.textContent = "‚úîÔ∏è";
      estado.className = "estado valido";
    } else {
      input.classList.add("invalido");
      input.classList.remove("valido");
      estado.textContent = "‚ùå";
      estado.className = "estado invalido";
    }
  }

  input.addEventListener("input", validar);
  input.addEventListener("blur", validar);

  return wrap;
}

function crearCampoTelefono(labelText, name, required, codFieldName) {
  const wrap = document.createElement("div");
  wrap.className = "campo telefono";

  // Render: Select COD + Input Tel√©fono en la misma fila
  wrap.innerHTML = `
    <!-- üîπ Campo TEL√âFONO: ${labelText} (COD + 7 d√≠gitos) -->
    <label for="${name}">${labelText}</label>
    <div class="telefono-group">
      <select id="${codFieldName}" name="${codFieldName}">
        <option value="">COD</option>
        <!-- ‚ö†Ô∏è Opciones se llenan din√°micamente desde ListasFijas -->
      </select>
      <input type="text" inputmode="numeric" id="${name}" name="${name}" 
             ${required ? "required" : ""} placeholder="7 d√≠gitos" />
      <span class="estado"></span>
    </div>
  `;

  // Validaci√≥n visual en tiempo real
  const input = wrap.querySelector(`#${name}`);
  const select = wrap.querySelector(`#${codFieldName}`);
  const estado = wrap.querySelector(".estado");

  function validar() {
    const tel = (input.value || "").replace(/\D/g, "");
    const cod = select.value;
    if (cod && tel.length === 7) {
      input.classList.add("valido");
      input.classList.remove("invalido");
      estado.textContent = "‚úîÔ∏è";
      estado.className = "estado valido";
    } else {
      input.classList.add("invalido");
      input.classList.remove("valido");
      estado.textContent = "‚ùå";
      estado.className = "estado invalido";
    }
  }

  input.addEventListener("input", validar);
  select.addEventListener("change", validar);

  return wrap;
}

  function crearCampoRIF(labelText, name, required) {
    const wrap = document.createElement("div");
    wrap.className = "campo rif";
    wrap.innerHTML = `
      <!-- üîπ Campo RIF: ${labelText} (J/V/E + 9 d√≠gitos) -->
      <label for="${name}">${labelText}</label>
      <div class="rif-group">
        <select id="${name}_tipo" name="${name}_tipo" ${required ? "required" : ""}>
          <option value="">Tipo</option>
          <option value="J">J</option>
          <option value="V">V</option>
          <option value="E">E</option>
        </select>
        <input type="text" inputmode="numeric" id="${name}_numero" name="${name}_numero" 
              ${required ? "required" : ""} placeholder="9 d√≠gitos" />
        <span class="estado"></span>
      </div>
      <!-- üí¨ Validaci√≥n visual ‚úîÔ∏è/‚ùå integrada -->
    `;

    const select = wrap.querySelector(`#${name}_tipo`);
    const input = wrap.querySelector(`#${name}_numero`);
    const estado = wrap.querySelector(".estado");

    function validar() {
      const rifNum = (input.value || "").replace(/\D/g, "");
      const tipo = select.value;
      if (tipo && rifNum.length === 9) {
        input.classList.add("valido");
        input.classList.remove("invalido");
        estado.textContent = "‚úîÔ∏è";
        estado.className = "estado valido";
      } else {
        input.classList.add("invalido");
        input.classList.remove("valido");
        estado.textContent = "‚ùå";
        estado.className = "estado invalido";
      }
    }

    input.addEventListener("input", validar);
    select.addEventListener("change", validar);

    return wrap;
  }

function crearCampoEmail(labelText, name, required) {
  const wrap = document.createElement("div");
  wrap.className = "campo email";
  wrap.innerHTML = `
    <!-- üîπ Campo EMAIL: ${labelText} (prohibido dominio cantv) -->
    <label for="${name}">${labelText}</label>
    <input type="email" id="${name}" name="${name}" ${required ? "required" : ""} />
    <span class="estado"></span>
    <!-- üí¨ Validaci√≥n visual ‚úîÔ∏è/‚ùå integrada -->
  `;

  const input = wrap.querySelector(`#${name}`);
  const estado = wrap.querySelector(".estado");

  function validar() {
    const val = input.value.trim();
    const regex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/; // formato b√°sico de email

    if (regex.test(val) && !val.toLowerCase().includes("cantv")) {
      input.classList.add("valido");
      input.classList.remove("invalido");
      estado.textContent = "‚úîÔ∏è";
      estado.className = "estado valido";
    } else {
      input.classList.add("invalido");
      input.classList.remove("valido");
      estado.textContent = "‚ùå";
      estado.className = "estado invalido";
    }
  }

  input.addEventListener("input", validar);
  input.addEventListener("blur", validar);

  return wrap;
}

function crearCampoSelect(labelText, name, opciones, required) {
  const wrap = document.createElement("div");
  wrap.className = "campo select";

  // Si no hay opciones, lo dejamos vac√≠o para que el flujo no rompa
  const opts = Array.isArray(opciones) ? opciones : [];
  const optsHTML = opts.map(v => `<option value="${v}">${v}</option>`).join("");

  wrap.innerHTML = `
    <!-- üîπ Campo SELECT: ${labelText} -->
    <!-- ‚ö†Ô∏è Se llena desde ListasFijas -->
    <label for="${name}">${labelText}</label>
    <select id="${name}" name="${name}" ${required ? "required" : ""}>
      <option value="">Seleccione...</option>
      ${optsHTML}
    </select>
    <span class="estado"></span>
    <!-- üí¨ Validaci√≥n visual ‚úîÔ∏è/‚ùå integrada -->
  `;

  const select = wrap.querySelector(`#${name}`);
  const estado = wrap.querySelector(".estado");

  function validar() {
    if (select.value && select.value !== "") {
      select.classList.add("valido");
      select.classList.remove("invalido");
      estado.textContent = "‚úîÔ∏è";
      estado.className = "estado valido";
    } else {
      select.classList.add("invalido");
      select.classList.remove("valido");
      estado.textContent = "‚ùå";
      estado.className = "estado invalido";
    }
  }

  select.addEventListener("change", validar);
  select.addEventListener("blur", validar);

  return wrap;
}

function crearCampoDate(labelText, name, required) {
  const wrap = document.createElement("div");
  wrap.className = "campo date";
  wrap.innerHTML = `
    <!-- üîπ Campo DATE: ${labelText} (dd/mm/aaaa, zona horaria Caracas) -->
    <label for="${name}">${labelText}</label>
    <input type="date" id="${name}" name="${name}" ${required ? "required" : ""} />
    <span class="estado"></span>
    <!-- üí¨ Validaci√≥n visual ‚úîÔ∏è/‚ùå integrada -->
  `;

  const input = wrap.querySelector(`#${name}`);
  const estado = wrap.querySelector(".estado");

  function validar() {
    const val = input.value;
    if (val) {
      // Normalizar formato a dd/mm/aaaa
      const fecha = new Date(val);
      const dia = String(fecha.getDate()).padStart(2, "0");
      const mes = String(fecha.getMonth() + 1).padStart(2, "0");
      const anio = fecha.getFullYear();
      input.dataset.normalizado = `${dia}/${mes}/${anio}`;

      input.classList.add("valido");
      input.classList.remove("invalido");
      estado.textContent = "‚úîÔ∏è";
      estado.className = "estado valido";
    } else {
      input.classList.add("invalido");
      input.classList.remove("valido");
      estado.textContent = "‚ùå";
      estado.className = "estado invalido";
    }
  }

  input.addEventListener("change", validar);
  input.addEventListener("blur", validar);

  return wrap;
}

function crearCampoRadioSiNo(labelText, name) {
  const wrap = document.createElement("div");
  wrap.className = "campo radio";
  wrap.innerHTML = `
    <!-- üîπ Campo RADIO (S√≠/No) moderno: ${labelText} -->
    <span class="label">${labelText}</span>
    <div class="radio-group">
      <label>
        <input type="radio" name="${name}" value="S√≠" />
        <span class="radio-ui"></span>
        S√≠
      </label>
      <label>
        <input type="radio" name="${name}" value="No" />
        <span class="radio-ui"></span>
        No
      </label>
      <span class="estado"></span>
    </div>
    <!-- üí¨ Validaci√≥n visual ‚úîÔ∏è/‚ùå integrada -->
  `;

  const radios = wrap.querySelectorAll(`input[name="${name}"]`);
  const estado = wrap.querySelector(".estado");

  function validar() {
    let checked = false;
    radios.forEach(r => { if (r.checked) checked = true; });
    if (checked) {
      estado.textContent = "‚úîÔ∏è";
      estado.className = "estado valido";
    } else {
      estado.textContent = "‚ùå";
      estado.className = "estado invalido";
    }
  }

  radios.forEach(r => r.addEventListener("change", validar));

  return wrap;
}

// ============================
// üì® ENV√çO DEL FORMULARIO (validaci√≥n + normalizaci√≥n)
// ============================
  function enviarCargaDemanda(event) {
    event.preventDefault();

    const form = document.getElementById("formCargaDemanda");
    const data = {};

    [...form.elements].forEach(el => {
      if (!el.name) return;
      if (el.type === "radio") {
        if (el.checked) data[el.name] = el.value;
        return;
      }
      data[el.name] = el.value;
    });

  // Validaciones y normalizaciones espec√≠ficas

  // TEXTO ‚Üí Nombre Propio
  const camposTextoNombrePropio = [
    "nombrecontacto", "cliente", "calle", "edificio", "piso", "local",
    "ciudad", "sector", "cono", "direccioninstalacion", "observacionventas"
  ];
  camposTextoNombrePropio.forEach(k => {
    if (k in data) data[k] = toNombrePropio(data[k]);
  });

  // EMAIL ‚Üí prohibir dominio cantv
  if ("correo" in data) {
    const valid = validarEmailNoCantv(data["correo"]);
    if (!valid) return mostrarError("Correo inv√°lido o dominio cantv no permitido");
    data["correo"] = valid;
  }

  // C√âDULA ‚Üí 7 u 8 d√≠gitos, sin espacios/guiones
  if ("cedula" in data) {
    const clean = (data["cedula"] || "").replace(/\D/g, "");
    if (clean.length < 7 || clean.length > 8) return mostrarError("C√©dula debe tener 7 u 8 d√≠gitos");
    data["cedula"] = clean;
  }

  // TEL√âFONOS ‚Üí 7 d√≠gitos exactos
  ["telefono", "telefono2", "telefono3"].forEach(name => {
    if (name in data && data[name]) {
      const clean = (data[name] || "").replace(/\D/g, "");
      if (clean.length !== 7) return mostrarError(`${name} debe tener exactamente 7 d√≠gitos`);
      data[name] = clean;
    }
  });

  // RIF ‚Üí J/V/E + hasta 9 d√≠gitos, completa con ceros a 9, sin espacios ni guiones
  if ("rif" in data) {
    const rif = normalizarRIF(data["rif"]);
    if (!rif) return mostrarError("RIF inv√°lido (Formato: J/V/E + 9 d√≠gitos, sin espacios ni guiones)");
    data["rif"] = rif;
  }

  // CENTRAL ‚Üí "NNNN" o "NNNNL"
  if ("central" in data) {
    const val = validarCentral(data["central"]);
    if (!val) return mostrarError("Central inv√°lida (4 d√≠gitos o 4 d√≠gitos + 1 letra)");
    data["central"] = val;
  }

  // MONTO PAGO ‚Üí "1.234,56" o "0,00" si vac√≠o
  if ("montopago" in data) {
    data["montopago"] = formatearMonto(data["montopago"]);
  } else {
    data["montopago"] = "0,00";
  }

  // CONCATENACIONES COD + TEL√âFONO
  const concatMap = [
    { cod: "cod", tel: "telefono", out: "telefono" },
    { cod: "cod2", tel: "telefono2", out: "telefono2" },
    { cod: "cod3", tel: "telefono3", out: "telefono3" },
  ];
  for (const { cod, tel, out } of concatMap) {
    if (data[cod] && data[tel]) {
      const comb = concatCodTelefono(data[cod], data[tel]);
      if (!comb) return mostrarError(`Concatenaci√≥n inv√°lida: ${cod} + ${tel}`);
      data[out] = comb;
    }
  }

  // SERVICIO MODERNIZADO con COD4
  if (data["cod4"] && data["serviciomodernizado"]) {
    const comb = concatCodTelefono(data["cod4"], data["serviciomodernizado"]);
    if (!comb) return mostrarError("Concatenaci√≥n inv√°lida: COD 4 + Servicio Modernizado (7 d√≠gitos)");
    data["serviciomodernizado"] = comb;
  }

  // NRO VOZ IP con COD5 (3 d√≠gitos) + TEL (7)
  if (data["cod5"] && data["nrovozip"]) {
    const comb = concatCod3Tel7(data["cod5"], data["nrovozip"]);
    if (!comb) return mostrarError("Concatenaci√≥n inv√°lida: COD 5 (3 d√≠gitos) + Nro Voz IP (7 d√≠gitos)");
    data["nrovozip"] = comb;
  }

  // DATES ‚Üí usar dataset.normalizado si existe
  if (form.fechaabordaje && form.fechaabordaje.dataset.normalizado) {
    data["fechaabordaje"] = form.fechaabordaje.dataset.normalizado;
  }
  if (form.fechaaceptacion && form.fechaaceptacion.dataset.normalizado) {
    data["fechaaceptacion"] = form.fechaaceptacion.dataset.normalizado;
  }

  console.log("üß† [LOG] Datos normalizados a enviar:", data);

    // Enviar a Apps Script - AHORA: llamar cargarDemanda (sin wrappers)
    google.script.run
      .withSuccessHandler(() => {
        console.log("‚úÖ Demanda registrada correctamente");
        alert("Demanda registrada correctamente");
      })
      .withFailureHandler(err => {
        console.error("‚ùå Error al registrar demanda:", err);
        alert("Error al registrar demanda: " + (err && err.message ? err.message : err));
      })
      .cargarDemanda(data); // ‚Üê llamada directa a la funci√≥n del servidor renombrada
  }

  function mostrarError(msg) {
    console.error("‚ùå [VALIDACI√ìN]", msg);
    alert(msg);
  }

    // ============================
  // üöÄ INICIALIZACI√ìN INMEDIATA (parche)
  // ============================
  // Antes: se usaba DOMContentLoaded (no se ejecuta cuando el fragmento se inyecta).
  // Ahora: llamamos inmediatamente para pedir ListasFijas y renderizar.
  (function initCargarDemanda() {
    google.script.run
      .withSuccessHandler(function(listas) {
        try {
          renderFormulario(listas || {});
        } catch (e) {
          console.error("‚ùå Error renderizando formulario:", e);
          renderFormulario({});
        }
      })
      .withFailureHandler(err => {
        console.error("‚ùå Error al cargar ListasFijas:", err);
        renderFormulario({});
      })
      .getListasFijas();
  });
    </script>

      <style>
      /* ============================
        üé® Estilos m√≠nimos y radio moderno
        ============================ */
      form { display: grid; gap: 16px; }
      fieldset { border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
      legend { font-weight: 600; }
      .campo { display: grid; gap: 6px; }
      label { font-weight: 500; }

      /* Grupo tel√©fono: COD + n√∫mero */
      .telefono-group { display: flex; gap: 8px; align-items: center; }

      /* Estados visuales ‚úîÔ∏è/‚ùå */
      .campo input.valido, .campo select.valido { border-color: green; }
      .campo input.invalido, .campo select.invalido { border-color: red; }

      .estado { font-size: 14px; margin-left: 6px; }
      .estado.valido { color: green; }
      .estado.invalido { color: red; }

      /* Grupo RIF: Select J/V/E + n√∫mero */
      .rif-group { display: flex; gap: 8px; align-items: center; }

      /* Radio moderno */
      .radio-group { display: flex; gap: 16px; align-items: center; }
      .radio-group label { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }
      .radio-group input[type="radio"] { display: none; }
      .radio-ui {
        width: 18px; height: 18px; border-radius: 50%;
        border: 2px solid #555; display: inline-flex; align-items: center; justify-content: center;
      }
      .radio-group input[type="radio"]:checked + .radio-ui {
        border-color: #0a84ff;
        box-shadow: 0 0 0 2px rgba(10,132,255,0.2);
      }
      .radio-group input[type="radio"]:checked + .radio-ui::after {
        content: ""; width: 8px; height: 8px; background: #0a84ff; border-radius: 50%;
      }
      </style>
