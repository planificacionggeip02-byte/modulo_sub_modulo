<!-- ============================
üßæ Subm√≥dulo: Cargar Demanda
============================= -->
<div id="contenedor-formulario"></div>

<script>
  console.log("üß™ Maqueta Cargar Demanda inicial cargada (versi√≥n ajustada)");

  // ============================
  // üîß UTILIDADES DE NORMALIZACI√ìN
  // ============================
  function toNombrePropio(str) {
    if (!str) return "";
    return str
      .toLowerCase()
      .split(/\s+/)
      .map(w => w.charAt(0).toUpperCase() + w.slice(1))
      .join(" ");
  }

  function normalizeKey(str) {
    return (str || "")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-zA-Z0-9_]/g, "")
      .toLowerCase();
  }

  function soloDigitos(str, lenExacta) {
    const clean = (str || "").replace(/\D/g, "");
    return lenExacta ? (clean.length === lenExacta ? clean : null) : clean;
  }

  function formatearMonto(montoStr) {
    let s = (montoStr || "").trim();
    if (!s) return "0,00";
    s = s.replace(/\./g, "").replace(/\s+/g, "");
    s = s.replace(/,/g, ".");
    const n = parseFloat(s);
    if (isNaN(n)) return "0,00";
    const fixed = n.toFixed(2);
    const [enteros, decimales] = fixed.split(".");
    const enterosConMiles = enteros.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return `${enterosConMiles},${decimales}`;
  }

  function normalizarRIF(input) {
    const s = (input || "").trim().toUpperCase().replace(/[\s-]/g, "");
    if (!/^[JVE]/.test(s)) return null;
    const letra = s.charAt(0);
    const digitos = s.slice(1).replace(/\D/g, "");
    if (digitos.length === 0 || digitos.length > 9) return null;
    const padded = digitos.padEnd(9, "0");
    return `${letra}${padded}`;
  }

  function validarCentral(input) {
    const s = (input || "").trim().toUpperCase();
    if (/^\d{4}$/.test(s)) return s;
    if (/^\d{4}[A-Z]$/.test(s)) return s;
    return null;
  }

  function concatCodTelefono(cod, tel7) {
    const t = (tel7 || "").replace(/\D/g, "");
    if (!cod || t.length !== 7) return null;
    return `${cod}${t}`;
  }

  function concatCod3Tel7(cod3, tel7) {
    const c = (cod3 || "").replace(/\D/g, "");
    const t = (tel7 || "").replace(/\D/g, "");
    if (c.length !== 3 || t.length !== 7) return null;
    return `${c}${t}`;
  }

  function validarEmailNoCantv(email) {
    const e = (email || "").trim();
    if (!e) return null;
    const cantv = /@cantv(\.com)?\.ve$/i;
    if (cantv.test(e)) return null;
    const basic = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return basic.test(e) ? e : null;
  }

  // ============================
  // üî∑ RENDER FORMULARIO + POBLADO DE LISTAS
  // ============================
  function renderFormulario(listas = {}) {
    console.log("üöÄ Entrando a renderFormulario con listas:", listas);
    const form = document.createElement("form");
    form.id = "formCargaDemanda";
    form.onsubmit = enviarCargaDemanda;

    // ============================
    // üî∑ BLOQUE: Informaci√≥n Personal
    // ============================
    const personal = document.createElement("fieldset");
    personal.className = "bloque-personal";
    personal.innerHTML = `<legend>Informaci√≥n Personal</legend>`;
    form.appendChild(personal);

    personal.appendChild(crearCampoTexto("Nombre Contacto", "nombrecontacto", true));
    personal.appendChild(crearCampoNumero("C√©dula", "cedula", true, { minLen: 7, maxLen: 8 }));
    personal.appendChild(crearCampoEmail("Correo", "correo", true));

    personal.appendChild(crearCampoTelefono("Tel√©fono", "telefono", true, "cod"));
    personal.appendChild(crearCampoTelefono("Tel√©fono 2", "telefono2", false, "cod2"));
    personal.appendChild(crearCampoTelefono("Tel√©fono 3", "telefono3", false, "cod3"));

    // ============================
    // üî∑ BLOQUE: Informaci√≥n Cliente
    // ============================
    const cliente = document.createElement("fieldset");
    cliente.className = "bloque-cliente";
    cliente.innerHTML = `<legend>Informaci√≥n Cliente</legend>`;
    form.appendChild(cliente);

    cliente.appendChild(crearCampoTexto("Cliente", "cliente", true));
    cliente.appendChild(crearCampoTexto("Rif", "rif", true));
    cliente.appendChild(crearCampoTexto("Calle", "calle", false));
    cliente.appendChild(crearCampoTexto("Edificio", "edificio", false));
    cliente.appendChild(crearCampoTexto("Piso", "piso", false));
    cliente.appendChild(crearCampoTexto("Local", "local", false));
    cliente.appendChild(crearCampoSelect("Regi√≥n", "region", listas["Lista_Region"] || [], true));
    cliente.appendChild(crearCampoSelect("Gerente Regi√≥n", "gerenteregion", listas["Lista_Gerente_Region"] || listas["Lista_Gerente"] || [], false));
    cliente.appendChild(crearCampoSelect("Estado", "estado", listas["Lista_Estado"] || [], false));
    cliente.appendChild(crearCampoSelect("Municipio", "municipio", listas["Lista_Municipio"] || [], false));
    cliente.appendChild(crearCampoTexto("Ciudad", "ciudad", false));
    cliente.appendChild(crearCampoSelect("Huella", "huella", listas["Lista_ODN"] || [], false));
    cliente.appendChild(crearCampoTexto("Sector", "sector", false));
    cliente.appendChild(crearCampoTexto("Cono O Modulo", "cono", false));

    // ============================
    // üî∑ BLOQUE: Informaci√≥n Servicio
    // ============================
    const servicio = document.createElement("fieldset");
    servicio.className = "bloque-servicio";
    servicio.innerHTML = `<legend>Informaci√≥n Servicio</legend>`;
    form.appendChild(servicio);

    servicio.appendChild(crearCampoSelect("Medio Abordaje", "medioabordaje", listas["Lista_Medio_Abordaje"] || [], true));
    servicio.appendChild(crearCampoSelect("Situaci√≥n Abordaje", "situacionabordaje", listas["Lista_Situacion"] || [], true));
    servicio.appendChild(crearCampoDate("Fecha Abordaje", "fechaabordaje", true));
    servicio.appendChild(crearCampoSelect("Estatus Local", "estatuslocal", listas["Lista_Estatus"] || [], true));
    servicio.appendChild(crearCampoRadioSiNo("Oferta Entregada", "ofertaentregada"));
    servicio.appendChild(crearCampoRadioSiNo("Oferta Aceptada", "ofertaaceptada"));
    servicio.appendChild(crearCampoSelect("Motivo No Aceptaci√≥n", "motivonoaceptacion", listas["Lista_No_Aceptacion"] || [], false));
    servicio.appendChild(crearCampoDate("Fecha Aceptaci√≥n", "fechaaceptacion", false));
    servicio.appendChild(crearCampoSelect("Aceptaci√≥n Recibida Por", "aceptacionrecibidapor", listas["Lista_Aceptacion_por"] || [], false));
    servicio.appendChild(crearCampoSelect("Abordado Por", "abordadopor", listas["Lista_Abordado_por"] || [], false));

    // ============================
    // üî∑ BOTONES DE ACCI√ìN (mantengo la estructura que tienes)
    // ============================
    const submitBtn = document.createElement("button");
    submitBtn.type = "submit";
    submitBtn.textContent = "Enviar Demanda";
    submitBtn.className = "btn btn-primary";

    const limpiarBtn = document.createElement("button");
    limpiarBtn.type = "button";
    limpiarBtn.textContent = "Limpiar";
    limpiarBtn.className = "btn btn-primary";
    limpiarBtn.addEventListener("click", () => {
      form.reset();
      form.querySelectorAll("input, select, textarea").forEach(el => {
        if (el.tagName === "SELECT") el.selectedIndex = 0;
        else if (el.type === "checkbox" || el.type === "radio") el.checked = false;
        else el.value = "";
        el.classList.remove("valido", "invalido");
      });
      form.querySelectorAll(".help, .error").forEach(el => el.textContent = "");
      form.querySelectorAll(".estado").forEach(e => { e.className = "estado"; e.innerHTML = ""; });
      const scroller = document.querySelector(".main-content");
      if (scroller) scroller.scrollTo({ top: 0, behavior: "smooth" });
    });

    const buttonGroup = document.createElement("div");
    buttonGroup.className = "form-buttons";
    buttonGroup.appendChild(submitBtn);
    buttonGroup.appendChild(limpiarBtn);
    form.appendChild(buttonGroup);

    // Insertar formulario
    const contenedor = document.getElementById("contenedor-formulario");
    contenedor.innerHTML = "";
    contenedor.appendChild(form);

    // POBLAR LISTAS (CODs, selects) y enlazar dependencias y comportamientos din√°micos
    try {
      poblarListasGlobales(listas);
      enlazarDependencias(listas);
      enlazarOfertaAceptada();
    } catch (e) {
      console.warn("‚ö†Ô∏è poblarListasGlobales/enlazarDependencias fall√≥:", e);
    }

    form.addEventListener("submit", enviarCargaDemanda);
    console.log("‚úÖ Formulario renderizado y listener de env√≠o asociado");
  }

  // ============================
  // üß± CONSTRUCTORES DE CAMPOS
  // (Conserv√© tu estructura y comentarios; s√≥lo ajust√© lo necesario)
  // ============================
  function crearCampoTexto(labelText, name, required) {
    const wrap = document.createElement("div");
    wrap.className = "campo texto";
    wrap.innerHTML = `
      <!-- üîπ Campo TEXTO: ${labelText} -->
      <label for="${name}">${labelText}</label>
      <input type="text" id="${name}" name="${name}" ${required ? "required" : ""} />
      <span class="estado"></span>
      <div class="error help" style="display:none;"></div>
    `;

    const input = wrap.querySelector(`#${name}`);
    const estado = wrap.querySelector(".estado");
    const errorBox = wrap.querySelector(".error");

    function validar() {
      const val = input.value; // permitimos espacios en todos los campos texto
      if (val.trim().length > 0) {
        // Mantener capitalizaci√≥n pero permitir espacios
        input.value = toNombrePropio(val);
        input.classList.add("valido"); input.classList.remove("invalido");
        estado.className = "estado valido"; estado.innerHTML = ""; // icon via CSS
        if (errorBox) { errorBox.style.display = "none"; errorBox.textContent = ""; }
      } else {
        input.classList.add("invalido"); input.classList.remove("valido");
        estado.className = "estado invalido"; estado.innerHTML = "";
      }
    }

    input.addEventListener("blur", validar);
    input.addEventListener("input", validar);

    return wrap;
  }

  function crearCampoNumero(labelText, name, required, opts = {}) {
    const wrap = document.createElement("div");
    wrap.className = "campo numero";
    wrap.innerHTML = `
      <!-- üîπ Campo N√öMERO: ${labelText} -->
      <label for="${name}">${labelText}</label>
      <input type="text" inputmode="numeric" id="${name}" name="${name}" ${required ? "required" : ""} />
      <span class="estado"></span>
    `;
    const input = wrap.querySelector(`#${name}`);
    const estado = wrap.querySelector(".estado");

    function validar() {
      const clean = (input.value || "").replace(/\D/g, "");
      const minLen = opts.minLen || 0;
      const maxLen = opts.maxLen || Infinity;
      if (clean.length >= minLen && clean.length <= maxLen && clean.length > 0) {
        input.classList.add("valido"); input.classList.remove("invalido");
        estado.className = "estado valido"; estado.innerHTML = "";
      } else {
        input.classList.add("invalido"); input.classList.remove("valido");
        estado.className = "estado invalido"; estado.innerHTML = "";
      }
    }

    input.addEventListener("input", validar);
    input.addEventListener("blur", validar);

    return wrap;
  }

  function crearCampoTelefono(labelText, name, required, codFieldName) {
    const wrap = document.createElement("div");
    wrap.className = "campo telefono";

    // Si no es requerido, mostrar "(opcional)" junto al label
    const labelTextFinal = required ? labelText : `${labelText} (opcional)`;

    // Render: Select COD + Input Tel√©fono en la misma fila (span.estado fuera del wrapper)
    wrap.innerHTML = `
      <!-- üîπ Campo TEL√âFONO: ${labelTextFinal} (COD + 7 d√≠gitos) -->
      <label for="${name}">${labelTextFinal}</label>
      <div class="telefono-group">
        <select id="${codFieldName}" name="${codFieldName}">
          <option value="">COD</option>
          <!-- opciones se llenan desde poblarListasGlobales() -->
        </select>
        <input type="text" inputmode="numeric" id="${name}" name="${name}" ${required ? "required" : ""} placeholder="7 d√≠gitos" />
      </div>
      <span class="estado"></span>
    `;

    const input = wrap.querySelector(`#${name}`);
    const select = wrap.querySelector(`#${codFieldName}`);
    const estado = wrap.querySelector(".estado");
    const telefonoWrapper = wrap.querySelector('.telefono-group');

    function validar() {
      const tel = (input.value || "").replace(/\D/g, "");
      const cod = select.value;
      if (cod && tel.length === 7) {
        input.classList.add("valido"); input.classList.remove("invalido");
        estado.className = "estado valido"; estado.innerHTML = "";
        if (telefonoWrapper) { telefonoWrapper.classList.add("valido"); telefonoWrapper.classList.remove("invalido"); }
      } else {
        input.classList.add("invalido"); input.classList.remove("valido");
        estado.className = "estado invalido"; estado.innerHTML = "";
        if (telefonoWrapper) { telefonoWrapper.classList.add("invalido"); telefonoWrapper.classList.remove("valido"); }
      }
    }

    input.addEventListener("input", validar);
    input.addEventListener("blur", validar);
    select.addEventListener("change", validar);

    return wrap;
  }

  function crearCampoRIF(labelText, name, required) {
    const wrap = document.createElement("div");
    wrap.className = "campo rif";
    wrap.innerHTML = `
      <!-- üîπ Campo RIF: ${labelText} (J/V/E + 9 d√≠gitos) -->
      <label for="${name}">${labelText}</label>
      <div class="rif-group">
        <select id="${name}_tipo" name="${name}_tipo" ${required ? "required" : ""}>
          <option value="">Tipo</option>
          <option value="J">J</option>
          <option value="V">V</option>
          <option value="E">E</option>
        </select>
        <input type="text" inputmode="numeric" id="${name}_numero" name="${name}_numero" ${required ? "required" : ""} placeholder="9 d√≠gitos" />
      </div>
      <span class="estado"></span>
    `;

    const select = wrap.querySelector(`#${name}_tipo`);
    const input = wrap.querySelector(`#${name}_numero`);
    const estado = wrap.querySelector(".estado");

    function validar() {
      const rifNum = (input.value || "").replace(/\D/g, "");
      const tipo = select.value;
      if (tipo && rifNum.length === 9) {
        input.classList.add("valido"); input.classList.remove("invalido");
        estado.className = "estado valido"; estado.innerHTML = "";
      } else {
        input.classList.add("invalido"); input.classList.remove("valido");
        estado.className = "estado invalido"; estado.innerHTML = "";
      }
    }

    input.addEventListener("input", validar);
    select.addEventListener("change", validar);

    return wrap;
  }

  function crearCampoEmail(labelText, name, required) {
    const wrap = document.createElement("div");
    wrap.className = "campo email";
    wrap.innerHTML = `
      <!-- üîπ Campo EMAIL: ${labelText} (prohibido dominio cantv) -->
      <label for="${name}">${labelText}</label>
      <input type="email" id="${name}" name="${name}" ${required ? "required" : ""} />
      <span class="estado"></span>
      <div class="error email-error" style="display:none;"></div>
    `;

    const input = wrap.querySelector(`#${name}`);
    const estado = wrap.querySelector(".estado");
    const emailError = wrap.querySelector(".email-error");

    function validar() {
      const val = input.value.trim();
      if (!val) {
        input.classList.remove("valido"); input.classList.remove("invalido");
        estado.className = "estado"; estado.innerHTML = "";
        if (emailError) { emailError.style.display = "none"; emailError.textContent = ""; }
        return;
      }
      const basic = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!basic.test(val)) {
        input.classList.add("invalido"); input.classList.remove("valido");
        estado.className = "estado invalido"; estado.innerHTML = "";
        if (emailError) { emailError.style.display = "block"; emailError.textContent = "Correo inv√°lido"; }
        return;
      }
      if (/@cantv(\.com)?\.ve$/i.test(val)) {
        input.classList.add("invalido"); input.classList.remove("valido");
        estado.className = "estado invalido"; estado.innerHTML = "";
        if (emailError) { emailError.style.display = "block"; emailError.textContent = "No se permite dominio @cantv"; }
        return;
      }
      input.classList.add("valido"); input.classList.remove("invalido");
      estado.className = "estado valido"; estado.innerHTML = "";
      if (emailError) { emailError.style.display = "none"; emailError.textContent = ""; }
    }

    input.addEventListener("input", validar);
    input.addEventListener("blur", validar);

    return wrap;
  }

  function crearCampoSelect(labelText, name, opciones, required) {
    const wrap = document.createElement("div");
    wrap.className = "campo select";

    const opts = Array.isArray(opciones) ? opciones : [];
    const optsHTML = opts.map(v => `<option value="${v}">${v}</option>`).join("");

    wrap.innerHTML = `
      <!-- üîπ Campo SELECT: ${labelText} -->
      <label for="${name}">${labelText}</label>
      <select id="${name}" name="${name}" ${required ? "required" : ""}>
        <option value="">Seleccione...</option>
        ${optsHTML}
      </select>
      <span class="estado"></span>
    `;

    const select = wrap.querySelector(`#${name}`);
    const estado = wrap.querySelector(".estado");

    function validar() {
      if (select.value && select.value !== "") {
        select.classList.add("valido"); select.classList.remove("invalido");
        estado.className = "estado valido"; estado.innerHTML = "";
      } else {
        select.classList.add("invalido"); select.classList.remove("valido");
        estado.className = "estado invalido"; estado.innerHTML = "";
      }
    }

    select.addEventListener("change", validar);
    select.addEventListener("blur", validar);

    return wrap;
  }

  function crearCampoDate(labelText, name, required) {
    const wrap = document.createElement("div");
    wrap.className = "campo date";
    wrap.innerHTML = `
      <!-- üîπ Campo DATE: ${labelText} (dd/mm/aaaa, zona horaria Caracas) -->
      <label for="${name}">${labelText}</label>
      <input type="date" id="${name}" name="${name}" ${required ? "required" : ""} />
      <span class="estado"></span>
    `;

    const input = wrap.querySelector(`#${name}`);
    const estado = wrap.querySelector(".estado");

    function validar() {
      const val = input.value;
      if (val) {
        const fecha = new Date(val);
        const dia = String(fecha.getDate()).padStart(2, "0");
        const mes = String(fecha.getMonth() + 1).padStart(2, "0");
        const anio = fecha.getFullYear();
        input.dataset.normalizado = `${dia}/${mes}/${anio}`;
        input.classList.add("valido"); input.classList.remove("invalido");
        estado.className = "estado valido"; estado.innerHTML = "";
      } else {
        input.classList.add("invalido"); input.classList.remove("valido");
        estado.className = "estado invalido"; estado.innerHTML = "";
      }
    }

    input.addEventListener("change", validar);
    input.addEventListener("blur", validar);

    return wrap;
  }

  function crearCampoRadioSiNo(labelText, name) {
    const wrap = document.createElement("div");
    wrap.className = "campo radio";
    wrap.innerHTML = `
      <!-- üîπ Campo RADIO (S√≠/No) moderno: ${labelText} -->
      <span class="label">${labelText}</span>
      <div class="radio-group">
        <label>
          <input type="radio" name="${name}" value="S√≠" />
          <span class="radio-ui"></span>
          S√≠
        </label>
        <label>
          <input type="radio" name="${name}" value="No" />
          <span class="radio-ui"></span>
          No
        </label>
        <span class="estado"></span>
      </div>
    `;

    const radios = wrap.querySelectorAll(`input[name="${name}"]`);
    const estado = wrap.querySelector(".estado");

    function validar() {
      let checked = false;
      radios.forEach(r => { if (r.checked) checked = true; });
      if (checked) {
        estado.className = "estado valido"; estado.innerHTML = "";
      } else {
        estado.className = "estado invalido"; estado.innerHTML = "";
      }
    }

    radios.forEach(r => r.addEventListener("change", validar));

    return wrap;
  }

  // ============================
  // üì• POBLAR LISTAS Y DEPENDENCIAS
  // ============================
  function poblarListasGlobales(listas = {}) {
    // Rellenar COD / cod2 / cod3 desde Lista_Cod (varias alternativas de claves)
    const codList = listas["Lista_Cod"] || listas["Lista_COD"] || listas["Lista_Codigos"] || listas["Lista_Codigos"] || [];
    ["cod", "cod2", "cod3"].forEach(id => {
      const sel = document.getElementById(id);
      if (sel) {
        sel.innerHTML = `<option value="">COD</option>` + codList.map(v => `<option value="${v}">${v}</option>`).join("");
      } else {
        // Si el select a√∫n no existe (render todav√≠a no insertado) lo rellenamos cuando se cree.
      }
    });

    // Rellenar selects est√°ticos: regi√≥n, huella, etc. (por si renderFormulario ya pas√≥ opciones)
    const mapKeys = {
      region: listas["Lista_Region"] || [],
      huella: listas["Lista_ODN"] || [],
      medioabordaje: listas["Lista_Medio_Abordaje"] || [],
      situacionabordaje: listas["Lista_Situacion"] || [],
      estatuslocal: listas["Lista_Estatus"] || [],
      motivonoaceptacion: listas["Lista_No_Aceptacion"] || [],
      aceptacionrecibidapor: listas["Lista_Aceptacion_por"] || [],
      abordadopor: listas["Lista_Abordado_por"] || [],
      gerenteregion: listas["Lista_Gerente_Region"] || listas["Lista_Gerente"] || []
    };

    Object.keys(mapKeys).forEach(name => {
      const sel = document.getElementById(name);
      if (sel) {
        const opts = mapKeys[name];
        sel.innerHTML = `<option value="">Seleccione...</option>` + opts.map(v => `<option value="${v}">${v}</option>`).join("");
      }
    });
  }

    // ============================================================
    // üßπ UTILIDAD: LIMPIAR SELECT
    // ============================================================
    // Deja un <select> vac√≠o con la opci√≥n inicial "Seleccione..."
    function limpiarSelect(sel) {
      if (!sel) return;
      sel.innerHTML = `<option value="">Seleccione...</option>`;
    }

    // ============================================================
    // üó∫Ô∏è DEPENDENCIAS REGIONALES
    // ============================================================
    function enlazarDependencias() {
      const regionSel = document.getElementById("region");
      const estadoSel = document.getElementById("estado");

      if (regionSel) {
        regionSel.addEventListener("change", () => {
          const region = regionSel.value;
          console.log("üîÑ Cambio de Regi√≥n:", region);

          // limpiar selects dependientes
          limpiarSelect(document.getElementById("gerenteregion"));
          limpiarSelect(document.getElementById("estado"));
          limpiarSelect(document.getElementById("municipio"));

          if (!region) return;

          // cargar Gerentes por Regi√≥n
          google.script.run.withSuccessHandler(arr => {
            console.log("üëâ Gerentes recibidos:", arr);
            poblarSelect(document.getElementById("gerenteregion"), arr);
          }).getGerentesPorRegion(region);

          // cargar Estados por Regi√≥n
          google.script.run.withSuccessHandler(arr => {
            console.log("üëâ Estados recibidos:", arr);
            poblarSelect(document.getElementById("estado"), arr);
          }).getEstadosPorRegion(region);
        });
      }

      if (estadoSel) {
        estadoSel.addEventListener("change", () => {
          const estado = estadoSel.value;
          console.log("üîÑ Cambio de Estado:", estado);

          limpiarSelect(document.getElementById("municipio"));
          if (!estado) return;

          // cargar Municipios por Estado
          google.script.run.withSuccessHandler(arr => {
            console.log("üëâ Municipios recibidos:", arr);
            poblarSelect(document.getElementById("municipio"), arr);
          }).getMunicipiosPorEstado(estado);
        });
      }
    }

    // ============================================================
    // üéØ MOSTRAR / OCULTAR CAMPOS SEG√öN OFERTA ACEPTADA
    // ============================================================
    function enlazarOfertaAceptada() {
      const radios = document.querySelectorAll('input[name="ofertaaceptada"]');
      if (!radios || radios.length === 0) return;

      const motivo = document.getElementById("motivonoaceptacion");
      const fecha = document.getElementById("fechaaceptacion");
      const aceptpor = document.getElementById("aceptacionrecibidapor");

      // üîπ Funci√≥n auxiliar para resetear campo y validadores
      function resetField(el) {
        if (!el) return;
        el.value = "";
        el.classList.remove("is-valid", "is-invalid");
        el.removeAttribute("aria-invalid");
        el.style.borderColor = "";
        el.style.boxShadow = "";
      }

      function toggle() {
        const val = Array.from(radios).find(r => r.checked)?.value;
        console.log("üîÑ Cambio en Oferta Aceptada:", val);

        if (!val) return;

        if (val.toLowerCase() === "no") {
          if (motivo) motivo.closest('.campo').style.display = "";
          if (fecha) {
            fecha.closest('.campo').style.display = "none";
            resetField(fecha); // üîπ limpiar y resetear validadores
          }
          if (aceptpor) {
            aceptpor.closest('.campo').style.display = "none";
            resetField(aceptpor); // üîπ limpiar y resetear validadores
          }
        } else {
          if (fecha) fecha.closest('.campo').style.display = "";
          if (aceptpor) aceptpor.closest('.campo').style.display = "";
          if (motivo) {
            motivo.closest('.campo').style.display = "none";
            resetField(motivo); // üîπ limpiar y resetear validadores
          }
        }
      }

      radios.forEach(r => r.addEventListener('change', toggle));

      // üîπ Ocultar todos al inicio
      if (motivo) motivo.closest('.campo').style.display = "none";
      if (fecha) fecha.closest('.campo').style.display = "none";
      if (aceptpor) aceptpor.closest('.campo').style.display = "none";
    }

  // ============================
  // üì® ENV√çO DEL FORMULARIO (validaci√≥n + normalizaci√≥n) y TOAST
  // ============================
  function mostrarToast(msg, tipo = "success") {
    // crea un toast simple en el contenedor-formulario
    const cont = document.getElementById("contenedor-formulario");
    if (!cont) { alert(msg); return; }
    const t = document.createElement("div");
    t.className = `cd-toast ${tipo}`;
    t.textContent = msg;
    Object.assign(t.style, {
      position: "fixed",
      right: "24px",
      top: "80px",
      zIndex: 9999,
      background: tipo === "success" ? "var(--color-primary)" : "#b00020",
      color: "#fff",
      padding: "10px 14px",
      borderRadius: "8px",
      boxShadow: "0 6px 18px rgba(0,0,0,0.12)",
      opacity: "1",
      transition: "opacity 0.4s ease"
    });
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = "0"; }, 4000);
    setTimeout(() => { t.remove(); }, 4500);
  }

  function enviarCargaDemanda(event) {
    event.preventDefault();
    const form = document.getElementById("formCargaDemanda");
    const data = {};

    [...form.elements].forEach(el => {
      if (!el.name) return;
      if (el.type === "radio") {
        if (el.checked) data[el.name] = el.value;
        return;
      }
      data[el.name] = el.value;
    });

    // Normalizaciones (mantengo las tuyas, pero con logging)
    const camposTextoNombrePropio = ["nombrecontacto", "cliente", "calle", "edificio", "piso", "local", "ciudad", "sector", "cono", "direccioninstalacion", "observacionventas"];
    camposTextoNombrePropio.forEach(k => { if (k in data) data[k] = toNombrePropio(data[k]); });

    if ("correo" in data) {
      const valid = validarEmailNoCantv(data["correo"]);
      if (!valid) {
        // mostrar error inline
        const emailError = document.querySelector('.campo.email .email-error');
        if (emailError) { emailError.style.display = "block"; emailError.textContent = "No se permite dominio @cantv"; }
        return mostrarError("Correo inv√°lido o dominio cantv no permitido");
      }
      data["correo"] = valid;
    }

    if ("cedula" in data) {
      const clean = (data["cedula"] || "").replace(/\D/g, "");
      if (clean.length < 7 || clean.length > 8) return mostrarError("C√©dula debe tener 7 u 8 d√≠gitos");
      data["cedula"] = clean;
    }

    ["telefono", "telefono2", "telefono3"].forEach(name => {
      if (name in data && data[name]) {
        const clean = (data[name] || "").replace(/\D/g, "");
        if (clean.length !== 7) return mostrarError(`${name} debe tener exactamente 7 d√≠gitos`);
        data[name] = clean;
      }
    });

    if ("rif" in data) {
      const rif = normalizarRIF(data["rif"]);
      if (!rif) return mostrarError("RIF inv√°lido (Formato: J/V/E + 9 d√≠gitos)");
      data["rif"] = rif;
    }

    if ("montopago" in data) data["montopago"] = formatearMonto(data["montopago"]);
    else data["montopago"] = "0,00";

    // Concatenar COD + TEL (ya tienes la l√≥gica)
    const concatMap = [
      { cod: "cod", tel: "telefono", out: "telefono" },
      { cod: "cod2", tel: "telefono2", out: "telefono2" },
      { cod: "cod3", tel: "telefono3", out: "telefono3" }
    ];
    for (const { cod, tel, out } of concatMap) {
      if (data[cod] && data[tel]) {
        const comb = concatCodTelefono(data[cod], data[tel]);
        if (!comb) return mostrarError(`Concatenaci√≥n inv√°lida: ${cod} + ${tel}`);
        data[out] = comb;
      }
    }

    // Log en cliente antes de enviar para depuraci√≥n (ver√°s en consola del navegador)
    console.log("üßæ [ENVIANDO] Datos a enviar a servidor:", data);

    google.script.run
      .withSuccessHandler(function(res) {
        console.log("‚úÖ Respuesta servidor:", res);
        mostrarToast("Demanda cargada con √©xito", "success");
        // dejar mensaje overlay (4s) y reset parcial
        setTimeout(() => { /* opcional: form.reset(); */ }, 4500);
      })
      .withFailureHandler(function(err) {
        console.error("‚ùå Error servidor:", err);
        mostrarToast("Error guardando demanda", "error");
      })
      .cargarDemanda(data);
  }

  function mostrarError(msg) {
    console.error("‚ùå [VALIDACI√ìN]", msg);
    // muestro toast de error y detengo
    mostrarToast(msg, "error");
  }

  // ============================
  // üöÄ INICIALIZACI√ìN INMEDIATA
  // ============================
  (function initCargarDemanda() {
    google.script.run
      .withSuccessHandler(function(listas) {
        try {
          // renderizar formulario (esto va a llamar poblarListasGlobales despu√©s)
          renderFormulario(listas || {});
        } catch (e) {
          console.error("‚ùå Error renderizando formulario:", e);
          renderFormulario({});
        }
      })
      .withFailureHandler(err => {
        console.error("‚ùå Error al cargar ListasFijas:", err);
        renderFormulario({});
      })
      .getListasFijas();
  })();
</script>

<style>
  /* ============================
    üé® Estilos m√≠nimos (mantenidos) + nuevas reglas para validadores modernos
    ============================ */
  form { display: grid; gap: 16px; }
  fieldset { border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
  legend { font-weight: 600; }
  .campo { display: grid; gap: 6px; position: relative; }
  label { font-weight: 500; }

  /* Grupo tel√©fono: COD + n√∫mero (ya integrado) */
  .telefono-group { display:flex; gap:0; align-items:center; border-radius:8px; overflow:visible; }

  /* modern validator: peque√±o c√≠rculo con icono blanco */
  .estado {
    width:18px; height:18px; border-radius:50%;
    display:inline-flex; align-items:center; justify-content:center;
    position:absolute; top:8px; right:10px;
    font-size:12px; line-height:1; color:transparent;
  }
  .estado.valido {
    background: #28a745; /* verde moderno */
  }
  .estado.valido::after {
    content: "‚úì"; color: #fff; font-size:12px;
  }
  .estado.invalido {
    background: #b00020;
  }
  .estado.invalido::after {
    content: "‚úï"; color: #fff; font-size:12px;
  }

  /* Estados visuales en bordes (mantenemos) */
  .campo input.valido, .campo select.valido { border-color: #28a745; box-shadow: 0 0 0 4px rgba(40,167,69,0.06); }
  .campo input.invalido, .campo select.invalido { border-color: #b00020; box-shadow: 0 0 0 4px rgba(176,0,32,0.06); }

  /* error help */
  .error { font-size:12px; color:#b00020; margin-top:4px; }

  .rif-group { display:flex; gap:8px; align-items:center; }

  .radio-group { display:flex; gap:16px; align-items:center; }
  .radio-group label { display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
  .radio-group input[type="radio"] { display:none; }
  .radio-ui { width:18px; height:18px; border-radius:50%; border:2px solid #555; display:inline-flex; align-items:center; justify-content:center; }
  .radio-group input[type="radio"]:checked + .radio-ui { border-color: #0a84ff; box-shadow: 0 0 0 2px rgba(10,132,255,0.2); }
  .radio-group input[type="radio"]:checked + .radio-ui::after { content:""; width:8px; height:8px; background:#0a84ff; border-radius:50%; }

  /* Bot√≥n principal */
  .btn-primary { background: var(--color-primary); color:#fff; padding:8px 14px; min-width:140px; margin:12px auto 0 auto; display:block; border-radius:8px; font-weight:700; }

  /* toast (cd-toast) se inyecta din√°micamente */
</style>
